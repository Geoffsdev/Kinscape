Kinscape
========

### Prerequisites

- Copy repository with

      git clone https://<github personal access token>@github.com/kinscape/kinscape.git

- Add github personal access token to your terminal config (eg .bash.rc) 

      export BUNDLE_GITHUB__COM=ghp_b7....

- Rails and Ruby installation guide - [GO RAILS](https://gorails.com/setup)
- Install Ruby version which is specified in `.ruby-version` file in root directory
- Use bundler >= 2.1.4
- Make sure you're running postgresql server with user called `root` able to CREATEDB

Required external apps:
- [FFmpeg](http://www.ffmpeg.org/download.html) - convert video to h264 if another codec is used
- [ImageMagic](https://imagemagick.org/script/download.php) - create image variants in lower resolutions

This repository comes equipped with a self-setup script:

    ./bin/setup

Get a development environment file by copying from example file (ask another developer for more data):

    cp .sample.env .env

After setting up, you can run the application using [foreman](https://ddollar.github.io/foreman):

    foreman start -f Procfile.dev

API documentation
-----------------

Documentation is available in development environment under `/api-docs` endpoint

To refresh documentation after changes in specs use 

    SWAGGER_DRY_RUN=0 rails rswag

This SWAGGER_DRY_RUN env variable explanation is here: [RSWAG Issue](https://github.com/rswag/rswag/issues/359)

Generating template for controller

    rails generate rspec:swagger Api::V1::FamiliesController

Docker - development
--------------------

In development version there are 3 services - postgresql database, rails server and webpack server

Run docker compose in the background
 
    docker-compose up -d

Create database and load schema

    docker-compose run app rails db:create db:schema:load

Run database migrations

    docker-compose run app rails db:migrate

Create seeds

    docker-compose run app rails db:seed

Mailer Preview
-------
Link to list with prepared previews

    http://localhost:3000/rails/mailers

File where previews methods are defined

    spec/mailers/previews/mailer_preview.rb

Testing
-------
### Unit
To run test suite, use the following command:

    bundle exec rspec

### Feature
To run test suite, use the following command:

    bundle exec cucumber

To run it with headless mode:

    CI=true bundle exec cucmber

Deployment
----------

[Heroku deployment documentation](https://devcenter.heroku.com/articles/git)

NOTE: Currently, deployment to `staging` is done automatically when
pull-request is merged into `master` branch.

To trigger deployment manually:

* setup Heroku remotes:

      git remote add staging git@heroku.com:kinscape-staging.git
      git remote add production git@heroku.com:kinscape-production.git


* deploy to `staging`:

    Create Pull Request to initiate code review cycle:

    When approved- Merge pull request or in less common situations when you need to manually push branch directly:

      git push staging <branch_name>:master

* deploy to `production`:

      git push production <branch_name>:master

Review applications
-------------------

In order to copy `staging` database to your review application, run:


    heroku pg:copy kinscape-staging::DATABASE_URL DATABASE_URL -a <REVIEW_APP_ID>


`REVIEW_APP_ID` - application name of Review App generated by Heroku.

In case of any problems check [Heroku PGBackups](https://devcenter.heroku.com/articles/heroku-postgres-backups).
